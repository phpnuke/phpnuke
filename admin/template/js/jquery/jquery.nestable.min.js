/*
 * Nestable jQuery Plugin - Copyright (c) 2012 David Bushell - http://dbushell.com/
 * Dual-licensed under the BSD or MIT licenses
 */
(function(e,g,h,c){var f="ontouchstart" in h;var b=(function(){var m=h.createElement("div"),n=h.documentElement;if(!("pointerEvents" in m.style)){return false}m.style.pointerEvents="auto";m.style.pointerEvents="x";n.appendChild(m);var l=g.getComputedStyle&&g.getComputedStyle(m,"").pointerEvents==="auto";n.removeChild(m);return !!l})();var k=f?"touchstart":"mousedown",j=f?"touchmove":"mousemove",a=f?"touchend":"mouseup";a=f?"touchend":"mouseup",eCancel=f?"touchcancel":"mouseup";var d={listNodeName:"ol",itemNodeName:"li",rootClass:"dd",listClass:"dd-list",itemClass:"dd-item",dragClass:"dd-dragel",handleClass:"dd-handle",collapsedClass:"dd-collapsed",placeClass:"dd-placeholder",noDragClass:"dd-nodrag",emptyClass:"dd-empty",expandBtnHTML:'<button data-action="expand" type="button">Expand</button>',collapseBtnHTML:'<button data-action="collapse" type="button">Collapse</button>',group:0,maxDepth:5,threshold:20,allowDecrease:true,allowIncrease:true,scroll:false,scrollSensitivity:1,scrollSpeed:5,scrollTriggers:{top:40,left:40,right:-40,bottom:-40}};function i(m,l){this.w=e(h);this.el=e(m);this.rtl=this.el.css("direction")=="rtl";this.options=e.extend({},d,l);this.init()}i.prototype={init:function(){var o=this;o.reset();o.el.data("nestable-group",this.options.group);o.placeEl=e('<div class="'+o.options.placeClass+'"/>');e.each(this.el.find(o.options.itemNodeName),function(p,q){o.setParent(e(q))});o.el.on("click","button",function(s){if(o.dragEl){return}var r=e(s.currentTarget),q=r.data("action"),p=r.parent(o.options.itemNodeName);if(q==="collapse"){o.collapseItem(p)}if(q==="expand"){o.expandItem(p)}});var l=function(q){if(q.isPropagationStopped()){return}var p=e(q.target);if(!p.hasClass(o.options.handleClass)){if(p.closest("."+o.options.noDragClass).length){return}p=p.closest("."+o.options.handleClass)}if(!p.length||o.dragEl){return}o.isTouch=/^touch/.test(q.type);if(o.isTouch&&q.touches.length!==1){return}q.preventDefault();o.dragStart(q.touches?q.touches[0]:q)};var n=function(p){if(o.dragEl){p.preventDefault();o.dragMove(p.touches?p.touches[0]:p)}};var m=function(p){if(o.dragEl){p.preventDefault();o.dragStop(p.touches?p.touches[0]:p)}};if(f){o.el[0].addEventListener("touchstart",l,false);g.addEventListener("touchmove",n,false);g.addEventListener("touchend",m,false);g.addEventListener("touchcancel",m,false)}o.el.on("mousedown",l);o.w.on("mousemove",n);o.w.on("mouseup",m)},add:function(n){if(!n.id||!n.text){return}var o=this,m=o.options,p=e("<"+m.itemNodeName+">");p.addClass(m.itemClass).append(e("<div>").addClass(m.handleClass).text(n.text));p.attr("data-id",n.id);for(var l in n){if(n.hasOwnProperty(l)&&l!="id"&&l!="text"){p.attr("data-"+l,n[l])}}o.el.find(m.itemNodeName).last().after(p)},serialize:function(){var n,o=0,m=this,l=function(s,q){var r=[],p=s.children(m.options.itemNodeName);p.each(function(){var t=e(this),v=e.extend({},t.data()),u=t.children(m.options.listNodeName);if(u.length){v.children=l(u,q+1)}r.push(v)});return r};n=l(m.el.find(m.options.listNodeName).first(),o);return n},serialise:function(){return this.serialize()},reset:function(){this.mouse={offsetX:0,offsetY:0,startX:0,startY:0,lastX:0,lastY:0,nowX:0,nowY:0,distX:0,distY:0,dirAx:0,dirX:0,dirY:0,lastDirX:0,lastDirY:0,distAxX:0,distAxY:0};this.isTouch=false;this.moving=false;this.dragEl=null;this.dragRootEl=null;this.dragDepth=0;this.dragLevel=0;this.hasNewRoot=false;this.pointEl=null},expandItem:function(l){l.removeClass(this.options.collapsedClass);l.children('[data-action="expand"]').hide();l.children('[data-action="collapse"]').show();l.children(this.options.listNodeName).show();this.el.trigger("expand",[l]);l.trigger("expand")},collapseItem:function(m){var l=m.children(this.options.listNodeName);if(l.length){m.addClass(this.options.collapsedClass);m.children('[data-action="collapse"]').hide();m.children('[data-action="expand"]').show();m.children(this.options.listNodeName).hide()}this.el.trigger("collapse",[m]);m.trigger("collapse")},expandAll:function(){var l=this;l.el.find(l.options.itemNodeName).each(function(){l.expandItem(e(this))})},collapseAll:function(){var l=this;l.el.find(l.options.itemNodeName).each(function(){l.collapseItem(e(this))})},isParent:function(l){return(l.find("button[data-action]").length!=0)},setParent:function(l){if(!this.isParent(l)){if(l.children(this.options.listNodeName).length){l.prepend(e(this.options.expandBtnHTML));l.prepend(e(this.options.collapseBtnHTML))}l.children('[data-action="expand"]').hide()}},unsetParent:function(l){l.removeClass(this.options.collapsedClass);l.children("[data-action]").remove();l.children(this.options.listNodeName).remove()},dragStart:function(r){var n=this.mouse,q=e(r.target),p=q.closest("."+this.options.handleClass).closest(this.options.itemNodeName);this.handle=q.closest("."+this.options.handleClass);n.handleOffsetX=r.pageX-this.handle.offset().left;n.handleOffsetY=r.pageY-this.handle.offset().top;this.target_width=this.handle.width();this.placeEl.css("height",p.height());n.offsetX=r.offsetX!==c?r.offsetX:r.pageX-q.offset().left;n.offsetY=r.offsetY!==c?r.offsetY:r.pageY-q.offset().top;n.startX=n.lastX=r.pageX;n.startY=n.lastY=r.pageY;this.dragLevel=p.parents(this.options.listNodeName).length;this.dragRootEl=this.el;this.dragEl=e(h.createElement(this.options.listNodeName)).addClass(this.options.listClass+" "+this.options.dragClass);this.dragEl.css("width",p.width());p.after(this.placeEl);p[0].parentNode.removeChild(p[0]);p.appendTo(this.dragEl);var m=0;if(this.rtl){m=this.dragEl.width()-this.target_width}e(h.body).append(this.dragEl);this.dragEl.css({left:r.pageX-n.handleOffsetX-1,top:r.pageY-n.handleOffsetY-1});var o,s,l=this.dragEl.find(this.options.itemNodeName);for(o=0;o<l.length;o++){s=e(l[o]).parents(this.options.listNodeName).length;if(s>this.dragDepth){this.dragDepth=s}}},dragStop:function(m){var l=this.dragEl.children(this.options.itemNodeName).first();l[0].parentNode.removeChild(l[0]);this.placeEl.replaceWith(l);this.dragEl.remove();this.el.trigger("change");if(this.hasNewRoot){this.dragRootEl.trigger("change")}this.reset()},dragMove:function(C){var B,r,w,x,D,l=this.options,s=this.mouse;var v=0;if(this.rtl){v=this.dragEl.width()-this.target_width}this.dragEl.css({left:C.pageX-s.handleOffsetX-1,top:C.pageY-s.handleOffsetY-1});s.lastX=s.nowX;s.lastY=s.nowY;s.nowX=C.pageX;s.nowY=C.pageY;s.distX=s.nowX-s.lastX;s.distY=s.nowY-s.lastY;s.lastDirX=s.dirX;s.lastDirY=s.dirY;s.dirX=s.distX===0?0:s.distX>0?1:-1;s.dirY=s.distY===0?0:s.distY>0?1:-1;var q=Math.abs(s.distX)>Math.abs(s.distY)?1:0;if(!s.moving){s.dirAx=q;s.moving=true;return}if(l.scroll){var n=false;var y=this.el.scrollParent()[0];if(y!=h&&y.tagName!="HTML"){if((l.scrollTriggers.bottom+y.offsetHeight)-C.pageY<l.scrollSensitivity){y.scrollTop=n=y.scrollTop+l.scrollSpeed}else{if(C.pageY-l.scrollTriggers.top<l.scrollSensitivity){y.scrollTop=n=y.scrollTop-l.scrollSpeed}}if((l.scrollTriggers.right+y.offsetWidth)-C.pageX<l.scrollSensitivity){y.scrollLeft=n=y.scrollLeft+l.scrollSpeed}else{if(C.pageX-l.scrollTriggers.left<l.scrollSensitivity){y.scrollLeft=n=y.scrollLeft-l.scrollSpeed}}}else{if(C.pageY-e(h).scrollTop()<l.scrollSensitivity){n=e(h).scrollTop(e(h).scrollTop()-l.scrollSpeed)}else{if(e(g).height()-(C.pageY-e(h).scrollTop())<l.scrollSensitivity){n=e(h).scrollTop(e(h).scrollTop()+l.scrollSpeed)}}if(C.pageX-e(h).scrollLeft()<l.scrollSensitivity){n=e(h).scrollLeft(e(h).scrollLeft()-l.scrollSpeed)}else{if(e(g).width()-(C.pageX-e(h).scrollLeft())<l.scrollSensitivity){n=e(h).scrollLeft(e(h).scrollLeft()+l.scrollSpeed)}}}}if(this.scrollTimer){clearTimeout(this.scrollTimer)}if(l.scroll&&n){this.scrollTimer=setTimeout(function(){e(g).trigger(C)},10)}if(s.dirAx!==q){s.distAxX=0;s.distAxY=0}else{s.distAxX+=Math.abs(s.distX);if(s.dirX!==0&&s.dirX!==s.lastDirX){s.distAxX=0}s.distAxY+=Math.abs(s.distY);if(s.dirY!==0&&s.dirY!==s.lastDirY){s.distAxY=0}}s.dirAx=q;if(s.dirAx&&s.distAxX>=l.threshold){s.distAxX=0;w=this.placeEl.prev(l.itemNodeName);var o=true;if(this.rtl&&s.distX>0){o=false}if(!this.rtl&&s.distX<0){o=false}if(l.allowIncrease&&o&&w.length&&!w.hasClass(l.collapsedClass)){B=w.find(l.listNodeName).last();D=this.placeEl.parents(l.listNodeName).length;if(D+this.dragDepth<=l.maxDepth){if(!B.length){B=e("<"+l.listNodeName+"/>").addClass(l.listClass);B.append(this.placeEl);w.append(B);this.setParent(w)}else{B=w.children(l.listNodeName).last();B.append(this.placeEl)}}}if(l.allowDecrease&&!o){x=this.placeEl.next(l.itemNodeName);if(!x.length){r=this.placeEl.parent();this.placeEl.closest(l.itemNodeName).after(this.placeEl);if(!r.children().length){this.unsetParent(r.parent())}}}}var u=false;if(!b){this.dragEl[0].style.visibility="hidden"}this.pointEl=e(h.elementFromPoint(C.pageX-h.documentElement.scrollLeft,C.pageY-(g.pageYOffset||h.documentElement.scrollTop)));if(!b){this.dragEl[0].style.visibility="visible"}if(this.pointEl.hasClass(l.handleClass)){this.pointEl=this.pointEl.closest(l.itemNodeName)}if(this.pointEl.hasClass(l.emptyClass)){u=true}else{if(!this.pointEl.length||!this.pointEl.hasClass(l.itemClass)){return}}var p=this.pointEl.closest("."+l.rootClass),m=this.dragRootEl.data("nestable-id")!==p.data("nestable-id");if(!s.dirAx||m||u){if(s.dirY==1){w=this.pointEl.prev(l.itemNodeName)}else{if(s.dirY==-1){w=this.pointEl.next(l.itemNodeName)}}if(m&&l.group!==p.data("nestable-group")){return}var A=this.pointEl.parents(l.listNodeName).length;var z=this.placeEl.parents(l.listNodeName).length;D=this.dragDepth-1+this.pointEl.parents(l.listNodeName).length;if(D>l.maxDepth){return}if(!l.allowIncrease&&this.dragLevel<A){return}if(!l.allowDecrease&&this.dragLevel>A&&(this.dragLevel-A!=1)){return}if((!l.allowDecrease||!l.allowIncrease)&&(this.dragLevel-A==1)){B=this.pointEl.find(l.listNodeName).last();if(!B.length){B=e(h.createElement(l.listNodeName)).addClass(l.listClass);B.append(this.placeEl);this.pointEl.append(B);this.setParent(this.pointEl)}if(w!=c&&this.isParent(w)&&w.find(l.listNodeName).children().length==0){this.unsetParent(w)}return}var t=C.pageY<(this.pointEl.offset().top+this.pointEl.height()/2);r=this.placeEl.parent();if(u){B=e(h.createElement(l.listNodeName)).addClass(l.listClass);B.append(this.placeEl);this.pointEl.replaceWith(B)}else{if(t){this.pointEl.before(this.placeEl)}else{this.pointEl.after(this.placeEl)}}if(!r.children().length){this.unsetParent(r.parent())}if(!this.dragRootEl.find(l.itemNodeName).length&&!this.dragRootEl.find("."+l.emptyClass).length){this.dragRootEl.append('<div class="'+l.emptyClass+'"/>')}if(m){this.hasNewRoot=this.el[0]!==this.dragRootEl[0]}}}};e.fn.nestable=function(o,n){var l=this,m=this;l.each(function(p){var q=e(this).data("nestable");if(!q){e(this).data("nestable",new i(this,o));e(this).data("nestable-id",new Date().getTime());e(this).data("nestable-id",p)}else{if(typeof o==="string"&&typeof q[o]==="function"){if(typeof n==="object"){m=q[o](n)}else{m=q[o]()}}}});return m||l}})(window.jQuery||window.Zepto,window,document);